<html>
    <head>
        <title>Test Data Generator</title>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js" type="text/javascript"></script>
        <script src="http://www.json.org/json2.js" type="text/javascript"></script>
        <script type="text/javascript">
            //When the DOM loads, activate some event handler functions
            $(document).ready(function() {              
                //Hide or show the appropriate fields when the user
                // chooses to generate either an election template or
                // random vote counts.
                $("#generationMode").change( function() {
                    idx = generationMode.selectedIndex;
                    val = generationMode[idx].value;
                    if(val=="election") {
                        $(".hideUs").addClass('noDisplay');                     
                    }
                    if(val=="counts") {
                        $(".hideUs").removeClass('noDisplay');
                    }
                });
                
                //Replace the displayFile div with the content of a
                // generated file when the name of that file is clicked.
                $("a.fileLinks").click( function() {
                    fname = $(this).attr("name");                   
                    $.post(".", {'displayThis':fname}, function(data){
                            //Make spaces and newlines in the file
                            // consistent with HTML
                            data = data.replace(/\n/g, "<br/>");
                            data = data.replace(/ /g, '&nbsp;');

                            //Generate markup that displays the contents
                            // of the file.
                            $("#displayFile").replaceWith('<div id = "displayFile"><h4>'
                             + fname + '</h4><p>'+ data + '</p></div>');
                        });
                });
                
                //Post file generation arguments to the server when the
                // user clicks the "run" button.
                $("#argsButton").click( function() {                                        
                    //Gather a list of arguments, the size of which
                    // depends on the type of data to generate.
                    args = new Array();
                    idx = generationMode.selectedIndex;
                    val = generationMode[idx].value;
                    if(val=="election") {                       
                        args.push(outputFilename.value);                        
                    }                   
                    if(val=="counts") {                     
                        args.push(howMany.value);
                        args.push(electionTemplate.value);
                        args.push(outputFilename.value);
                    }
                    
                    //Check to see if the user gave an output filename
                    // that is already in use. If so, then prompt to
                    // confirm overwrite.
                    fname = args[args.length-1];
                    alreadyExists = false;
                    overw = false;                     
                    if($("[name="+fname+"]").length!=0) {
                        alreadyExists = true;
                        overw = confirm("Overwrite file " + fname + "?");
                    }
                    //If the filename was not already in use, or the
                    // user confirmed the overwrite, then post
                    // arguments to the server.
                    if((alreadyExists == false) || (overw == true)) {                        
                        args = JSON.stringify(args)
                        $.post(".", {'arguments':args}, function(){
                            location.reload(true);
                        });                        
                    }
                });
                
                //When the delete button is clicked, make a list of
                // checked filenames. Post them to the server, flagged
                // for deletion, and remove corresponding html elements.
                $("#delButton").click( function() {
                    checkedFiles = new Array();
                    $("[type='checkbox']:checked").each(function() {                        
                        checkedFiles.push(this.id);                         
                        $(this).parents("div").remove();
                    });
                    $.post(".", {'delete':checkedFiles});
                });
                
                //When the rename buton is clicked, for each checked
                // filename display a textbox to the user allowing them
                // to rename checked files.
                $("#renButton").click( function() {
                    $("[type='checkbox']:checked").each(function() {                        
                        this.checked = false; //Uncheck checked boxes
                        $(this).addClass("hide");
                        $(this).next().addClass("noDisplay");
                        $(this).next().next().attr("value", $(this).attr("name"));
                        $(this).next().next().removeClass("noDisplay");                     
                        $(this).next().next().next().removeClass("noDisplay");                      
                    });
                });                
                
                //When the user is done renaming a file, post that data
                // to update the server on the change.
                $(".renDone").click( function() {           
                    //Gather the original filename and the new filename.
                    oldName = ($(this).attr("name"));
                    newName = ($(this).prev().attr("value"));
                    
                    //Change the names of corresponding HTML elements
                    $("a[name="+oldName+"]").attr({innerHTML: newName});
                    $("[name="+oldName+"]").attr("name", newName);
                    $("[id="+oldName+"]").attr({id:newName});
                    
                    //Update the server                
                    $.post(".", {'oldName':oldName, 'newName':newName});
                    
                    //Remove the textbox and button, restore the
                    // checkbox and link.
                    $(this).addClass("noDisplay");
                    $(this).prev().addClass("noDisplay");
                    $(this).prev().prev().removeClass("noDisplay");
                    $(this).prev().prev().prev().removeClass("hide");
                });
            });
        </script>

        <style type="text/css">         
            div#args {padding-bottom:50px}
            div#args div {font-weight:bold; padding-bottom:20px}
            div#displayFile {padding-bottom:40px; width:590px}              
            div#displayFile p {background-color:#E8E8E8;
                               font-size:12px;
                               font-family:"Courier New",Monospace;
                               padding-top:10px;
                               padding-left:10px;
                               padding-bottom:10px}
            .argInputs {position:absolute; left:290px}          
            .hide {visibility:hidden}
            .fileButtons {padding-top:10px}
            .noDisplay {display:none}
            a.fileLinks {color:blue}
            body {background-color:#FFE8BE} 
        </style>

    </head>

    <body>
        <h2>Generate New Files</h2>
        <div id=args>
            <div><label for="generationMode">Data type:</label>
            <select id="generationMode" class="argInputs">
                <option value="election">Random election template</option>
                <option value="counts">Random vote counts</option>
            </select></div>
            <div class="hideUs noDisplay"><label>Number of records in file:</label><input type="text" id="howMany" class="argInputs" /></div>
            <div class="hideUs noDisplay"><label>Election template file name:</label><input type="text" id="electionTemplate" class="argInputs" /></div>
            <div><label>Output file name:</label><input type="text" id="outputFilename" class="argInputs" /></div>
            <input type="submit" value="Run" id="argsButton" />
        </div>
        
        <div id = "displayFile">            
        </div>
        
        <h2>Generated Files</h2>
        {% for file in filelist %}
            <div>
                <input type="checkbox" class="fileBoxes" name="{{ file }}" id="{{ file }}" />
                <a class="fileLinks" name="{{ file }}" href="#top">{{ file }}</a>
                <input type="text" class="renText noDisplay" name="{{ file }}" />               
                <input type="submit" class="renDone noDisplay" name="{{ file }}" value="Done" />                
            </div>
        {% endfor %}
        <div class="fileButtons">
            <input type = "submit" value = "Delete" id = "delButton" />
            <input type = "submit" value = "Rename" id = "renButton" />
        </div>
    </body>
</html>
